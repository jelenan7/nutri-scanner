{% extends "base.html" %}
{% block title %}Smart Search{% endblock %}

{% block content %}

<form method="POST" style="display:flex;justify-content:space-between;gap:50px;margin-top:10px;">

<!-- ================= LEFT: FILTERS ================= -->
<div style="flex:1;">

  <div style="margin-bottom:18px;margin-top:-21px;margin-left:-17px;">
    <label style="font-weight:700;color:#42A475;font-size:14pt;display:block;margin-bottom:8px;">
      Product:
    </label>

    <div style="display:flex;align-items:center;gap:10px;">
      <input type="text" name="product" value="{{ filters.product }}"
        placeholder="e.g. Chocolate, yogurt, milk"
        style="flex:1;padding:8px;border:1px solid #42A475;border-radius:6px;font-size:14px;">
      <button type="submit" class="btn-search" name="action" value="search"
        style="width:80px;height:32px;">
        Search
      </button>
    </div>
  </div>

  <div style="display:grid;grid-template-columns:220px 1fr;gap:20px;">
    <div>
      {% for field,label in [
        ('sugar','Sugar'),('fat','Fat'),('energy','Energy'),
        ('carbs','Carbohydrates'),('protein','Proteins')
      ] %}
        <div style="margin-bottom:10px;">
        <div style="font-weight:700;font-size:12px;color:#555;">
          {{ label }} (max {{ 'kcal' if field == 'energy' else 'g' }})
        </div>

        <input type="number" step="0.1" name="{{ field }}"
          value="{{ filters[field] or '' }}"
          style="width:170px;padding:6px;border:1px solid #42A475;border-radius:6px;">
      </div>
      {% endfor %}
    </div>

    <div style="margin-top:14px;">
      {% for field,label in [
        ('vegan','Vegan'),
        ('gluten_free','Gluten Free'),
        ('lactose_free','Lactose Free'),
        ('available_mne','Available in MNE')
      ] %}
      <label style="display:flex;gap:6px;font-size:13px;">
        <input type="checkbox" name="{{ field }}" style="accent-color:#42A475"
          {% if filters[field] %}checked{% endif %}>
        {{ label }}
      </label>
      {% endfor %}
    </div>
  </div>
</div>

<!-- ================= RIGHT: RESULTS ================= -->
<div style="
  flex:1;
  position:relative;
  background:#f9f9f9;
  border-radius:10px;
  box-shadow:0 8px 21px rgba(0,0,0,0.1);
  padding:18px;
  min-height:380px;
">

{% if selected_product %}

<!-- ===== SCORES ===== -->
<div style="display:flex;justify-content:center;gap:15px;margin-bottom:20px;">

  {% if selected_product.nutriscore_img %}
    <img src="{{ selected_product.nutriscore_img }}"
         alt="Nutri-Score"
         style="height:45px;">
  {% endif %}

  {% if selected_product.nova_group %}
    <div style="background:#f60;color:white;border-radius:8px;
                padding:10px 11px;font-weight:bold;font-size:18px;height:40px;">
      NOVA {{ selected_product.nova_group }}
    </div>
  {% endif %}

  {% if selected_product.ecoscore_img %}
    <img src="{{ selected_product.ecoscore_img }}"
         alt="Eco-Score"
         style="height:40px;">
  {% endif %}

</div>

<!-- ===== IMAGE + TITLE ===== -->
<div style="display:flex;align-items:end;justify-content:center;
            gap:20px;margin-bottom:20px;">

  {% if selected_product.image_url %}
    <img src="{{ selected_product.image_url }}"
         alt="Product image"
         style="width:130px;height:130px;object-fit:cover;">
  {% else %}
    <div style="width:130px;height:130px;background:#eee;
                display:flex;align-items:center;justify-content:center;">
      No image
    </div>
  {% endif %}

  <div>
    <h2 style="font-size:25px;margin:0;">
      {{ selected_product.product_name or "Unknown product" }}
    </h2>
    <p style="color:gray;font-size:14px;">
      {{ selected_product.brands or "Unknown brand" }}
    </p>
  </div>
</div>

<!-- ===== NUTRITION ===== -->
<div style="font-size:15px;">
  <h3 style="margin-bottom:8px;">Nutritional Details (per 100g)</h3>

  <div style="display:flex;gap:30px;">
    <ul style="list-style:none;padding:0;line-height:1.7;">
      <li><strong>Energy:</strong> {{ selected_product.energy_kcal }} kcal</li>
      <li><strong>Fat:</strong> {{ selected_product.fat }} g</li>
      <li><strong>Sugars:</strong> {{ selected_product.sugars }} g</li>
      <li><strong>Proteins:</strong> {{ selected_product.protein }} g</li>
      <li><strong>Carbs:</strong> {{ selected_product.carbs }} g</li>
    </ul>

    <ul style="list-style:none;padding:0;line-height:1.7;">
      <li><strong>Vegan:</strong> {{ "Yes" if selected_product.is_vegan else "No" }}</li>
      <li><strong>Gluten Free:</strong> {{ "Yes" if selected_product.is_gluten_free else "No" }}</li>
      <li><strong>Lactose Free:</strong> {{ "Yes" if selected_product.is_lactose_free else "No" }}</li>
      <li><strong>Available in MNE:</strong> {{ "Yes" if selected_product.is_available_mne else "No" }}</li>
    </ul>
  </div>
</div>

<div style="text-align:right;margin-top:15px;">
  <button type="submit" name="action" value="back" class="btn-search">
    Back to list
  </button>
</div>

{% elif products %}

<ol style="margin-left:18px;line-height:1.6;padding-bottom:70px;">
  {% for p in products %}
    <li style="margin-bottom:10px;">
      <button type="submit" name="action" value="details:{{ p.code }}"
        style="border:none;background:none;color:#42A475;font-weight:600;cursor:pointer;">
        {{ p.product_name or "Unnamed product" }}
      </button>
      <div style="font-size:13px;color:#555;">
  sugar {{ p.nutriments.sugars_100g if p.nutriments and p.nutriments.sugars_100g is not none else '–' }} g |
  fat {{ p.nutriments.fat_100g if p.nutriments and p.nutriments.fat_100g is not none else '–' }} g |
  energy {{ p.nutriments['energy-kcal_100g'] if p.nutriments and p.nutriments['energy-kcal_100g'] is not none else '–' }} kcal |
  carbs {{ p.nutriments.carbohydrates_100g if p.nutriments and p.nutriments.carbohydrates_100g is not none else '–' }} g |
  proteins {{ p.nutriments.proteins_100g if p.nutriments and p.nutriments.proteins_100g is not none else '–' }} g
</div>

    </li>
  {% endfor %}
</ol>

{% include "pagination.j2" %}

{% else %}
<p style="text-align:center;color:gray;">
  Enter filters and click Search
</p>
{% endif %}

</div>
</form>
{% endblock %}
